var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
import { assert } from "./utils";
import { SingleSelection, ENTITY } from "./selection";
import { tracked } from "@glimmer/tracking";
import PrimaryKeyMap from "./primary-key-map";
export function isDataMatch(left, right) {
    if (isEntity(left) && isEntity(right)) {
        return left.table === right.table && isIdMatch(left.id, right.id);
    }
    else if (isEntity(left) || isEntity(right)) {
        return false;
    }
    else {
        return left === right;
    }
}
export function isIdMatch(left, right) {
    if (left.length !== right.length) {
        return false;
    }
    for (let i = 0; i < left.length; i++) {
        if (left[i] !== right[i]) {
            return false;
        }
    }
    return true;
}
export function isEntity(data) {
    return data !== null && typeof data === "object" && "table" in data;
}
export function normalizeDataType(data) {
    if (data instanceof SingleSelection) {
        return data[ENTITY];
    }
    else {
        return data;
    }
}
export class InternalRow {
    constructor(entity, columnNames, columns) {
        this.entity = entity;
        this.columnNames = columnNames;
        this.columns = columns;
    }
    static create(entity, row) {
        // TODO: Share column names
        let columnNames = Object.keys(row);
        let columns = Object.values(row).map(v => normalizeDataType(v));
        return new InternalRow(entity, columnNames, columns);
    }
    get id() {
        return this.entity.id;
    }
    update(updates) {
        for (let i = 0; i < this.columnNames.length; i++) {
            let columnName = this.columnNames[i];
            if (columnName in updates) {
                this.columns[i] = updates[columnName];
            }
        }
        // hack: invalidate columns
        this.columns = this.columns;
    }
    select(columns) {
        let out = Object.create(null);
        for (let column of columns) {
            out[column] = this.getColumn(column);
        }
        return out;
    }
    getColumn(name) {
        let index = this.columnIndex(name);
        return this.columns[index];
    }
    columnIndex(name) {
        let index = this.columnNames.indexOf(name);
        assert(index > -1, `You tried to match column ${name} in table ${this.entity.table} but it didn't exist (columns: ${this.columnNames.join(", ")})`);
        return index;
    }
    isMatch(query) {
        for (let key of Object.keys(query)) {
            let index = this.columnIndex(key);
            let pattern = query[key];
            let value = this.columns[index];
            if (!isDataMatch(pattern, value)) {
                return false;
            }
        }
        return true;
    }
}
__decorate([
    tracked
], InternalRow.prototype, "columns", void 0);
export const EMPTY = Symbol("EMPTY");
export const FILTER = Symbol("FILTER");
export const ADD_ROW = Symbol("ADD_ROW");
export const SCHEMA = Symbol("SCHEMA");
export default class Table {
    constructor(name, schema) {
        this.name = name;
        this.schema = schema;
        this.map = new PrimaryKeyMap();
    }
    get [SCHEMA]() {
        return this.schema;
    }
    [EMPTY]() {
        return new Table(this.name, this.schema);
    }
    [FILTER](query) {
        let out = [];
        for (let row of this.map.values()) {
            if (row.isMatch(query)) {
                out.push(row.entity);
            }
        }
        return out;
    }
    [ADD_ROW](row) {
        this.map.set(row.id, row);
        // hack: notify the map
        this.map = this.map;
        return {
            table: this.name,
            id: row.id
        };
    }
    all() {
        let out = [];
        for (let row of this.map.values()) {
            out.push({ table: this.name, id: row.id });
        }
        return out;
    }
    first() {
        for (let key of this.map.keys()) {
            return { table: this.name, id: key };
        }
        throw new Error(`Called first() on an empty database`);
    }
    get(id) {
        let row = this.map.get(id);
        assert(row, `Row not found (${id})`);
        return row;
    }
    add(row) {
        let userRow = InternalRow.create({ table: this.name, id: Array.isArray(row.id) ? row.id : [row.id] }, row);
        this[ADD_ROW](userRow);
        return userRow;
    }
    replace(id, newRow) {
        // TODO: Assert all columns present
        let row = this.get(id);
        row.update(newRow);
    }
}
__decorate([
    tracked
], Table.prototype, "map", void 0);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0YWJsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFDQSxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2pDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxFQUFTLE1BQU0sYUFBYSxDQUFDO0FBQzdELE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUM1QyxPQUFPLGFBQWEsTUFBTSxtQkFBbUIsQ0FBQztBQW9COUMsTUFBTSxVQUFVLFdBQVcsQ0FDekIsSUFBa0IsRUFDbEIsS0FBbUI7SUFFbkIsSUFBSSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ3JDLE9BQU8sSUFBSSxDQUFDLEtBQUssS0FBSyxLQUFLLENBQUMsS0FBSyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztLQUNuRTtTQUFNLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUM1QyxPQUFPLEtBQUssQ0FBQztLQUNkO1NBQU07UUFDTCxPQUFPLElBQUksS0FBSyxLQUFLLENBQUM7S0FDdkI7QUFDSCxDQUFDO0FBRUQsTUFBTSxVQUFVLFNBQVMsQ0FBQyxJQUFnQixFQUFFLEtBQWlCO0lBQzNELElBQUksSUFBSSxDQUFDLE1BQU0sS0FBSyxLQUFLLENBQUMsTUFBTSxFQUFFO1FBQ2hDLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7SUFFRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUNwQyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUU7WUFDeEIsT0FBTyxLQUFLLENB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LEVBQUUsR0FBRyxFQUFFLENBQUM7U0FDdEM7UUFFRCxNQUFNLElBQUksS0FBSyxDQUFDLHFDQUFxQyxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUVELEdBQUcsQ0FBQyxFQUFjO1FBQ2hCLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzNCLE1BQU0sQ0FBQyxHQUFHLEVBQUUsa0JBQWtCLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDckMsT0FBTyxHQUFHLENBQUM7SUFDYixDQUFDO0lBRUQsR0FBRyxDQUFDLEdBQXVCO1FBQ3pCLElBQUksT0FBTyxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQzlCLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUNuRSxHQUFHLENBQ0osQ0FBQztRQUNGLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN2QixPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRUQsT0FBTyxDQUFDLEVBQWMsRUFBRSxNQUEwQjtRQUNoRCxtQ0FBbUM7UUFDbkMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN2QixHQUFHLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3JCLENBQUM7Q0FDRjtBQTFFVTtJQUFSLE9BQU87a0NBQThDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNjaGVtYSBmcm9tIFwiLi9zY2hlbWFcIjtcbmltcG9ydCB7IGFzc2VydCB9IGZyb20gXCIuL3V0aWxzXCI7XG5pbXBvcnQgeyBTaW5nbGVTZWxlY3Rpb24sIEVOVElUWSwgUXVlcnkgfSBmcm9tIFwiLi9zZWxlY3Rpb25cIjtcbmltcG9ydCB7IHRyYWNrZWQgfSBmcm9tIFwiQGdsaW1tZXIvdHJhY2tpbmdcIjtcbmltcG9ydCBQcmltYXJ5S2V5TWFwIGZyb20gXCIuL3ByaW1hcnkta2V5LW1hcFwiO1xuaW1wb3J0IHsgVHlwZXMgfSBmcm9tIFwiLi9kYXRhYmFzZVwiO1xuXG5leHBvcnQgdHlwZSBTcGVjaWZpZWREYXRhVHlwZTxUIGV4dGVuZHMgVHlwZXMsIE4gZXh0ZW5kcyBrZXlvZiBUICYgc3RyaW5nPiA9XG4gIHwgc3RyaW5nXG4gIHwgbnVtYmVyXG4gIHwgYm9vbGVhblxuICB8IFByaW1hcnlLZXlcbiAgfCBFbnRpdHk8Tj5cbiAgfCBTaW5nbGVTZWxlY3Rpb248VCwgTj47XG5cbmV4cG9ydCB0eXBlIElkVmFsdWUgPSBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuO1xuZXhwb3J0IHR5cGUgRGF0YVZhbHVlPFQgZXh0ZW5kcyBUeXBlcz4gPVxuICB8IHN0cmluZ1xuICB8IG51bWJlclxuICB8IGJvb2xlYW5cbiAgfCBudWxsXG4gIHwgUHJpbWFyeUtleVxuICB8IEVudGl0eTxrZXlvZiBUICYgc3RyaW5nPjtcblxuZXhwb3J0IGZ1bmN0aW9uIGlzRGF0YU1hdGNoPFQgZXh0ZW5kcyBUeXBlcz4oXG4gIGxlZnQ6IERhdGFWYWx1ZTxUPixcbiAgcmlnaHQ6IERhdGFWYWx1ZTxUPlxuKTogYm9vbGVhbiB7XG4gIGlmIChpc0VudGl0eShsZWZ0KSAmJiBpc0VudGl0eShyaWdodCkpIHtcbiAgICByZXR1cm4gbGVmdC50YWJsZSA9PT0gcmlnaHQudGFibGUgJiYgaXNJZE1hdGNoKGxlZnQuaWQsIHJpZ2h0LmlkKTtcbiAgfSBlbHNlIGlmIChpc0VudGl0eShsZWZ0KSB8fCBpc0VudGl0eShyaWdodCkpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGxlZnQgPT09IHJpZ2h0O1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0lkTWF0Y2gobGVmdDogUHJpbWFyeUtleSwgcmlnaHQ6IFByaW1hcnlLZXkpOiBib29sZWFuIHtcbiAgaWYgKGxlZnQubGVuZ3RoICE9PSByaWdodC5sZW5ndGgpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBmb3IgKGxldCBpID0gMDsgaSA8IGxlZnQubGVuZ3RoOyBpKyspIHtcbiAgICBpZiAobGVmdFtpXSAhPT0gcmlnaHRbaV0pIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gdHJ1ZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGlzRW50aXR5PFQgZXh0ZW5kcyBUeXBlcywgTiBleHRlbmRzIGtleW9mIFQgJiBzdHJpbmc+KFxuICBkYXRhOiBEYXRhVmFsdWU8VD5cbik6IGRhdGEgaXMgRW50aXR5PE4+IHtcbiAgcmV0dXJuIGRhdGEgIT09IG51bGwgJiYgdHlwZW9mIGRhdGEgPT09IFwib2JqZWN0XCIgJiYgXCJ0YWJsZVwiIGluIGRhdGE7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBub3JtYWxpemVEYXRhVHlwZTxUIGV4dGVuZHMgVHlwZXMsIE4gZXh0ZW5kcyBrZXlvZiBUICYgc3RyaW5nPihcbiAgZGF0YTogU3BlY2lmaWVkRGF0YVR5cGU8VCwgTj5cbik6IERhdGFWYWx1ZTxUPiB7XG4gIGlmIChkYXRhIGluc3RhbmNlb2YgU2luZ2xlU2VsZWN0aW9uKSB7XG4gICAgcmV0dXJuIGRhdGFbRU5USVRZXTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZGF0YTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgSW50ZXJuYWxSb3c8VCBleHRlbmRzIFR5cGVzLCBOIGV4dGVuZHMga2V5b2YgVCAmIHN0cmluZz4ge1xuICBzdGF0aWMgY3JlYXRlPFQgZXh0ZW5kcyBUeXBlcywgTiBleHRlbmRzIGtleW9mIFQgJiBzdHJpbmc+KFxuICAgIGVudGl0eTogRW50aXR5PE4+LFxuICAgIHJvdzogeyBba2V5OiBzdHJpbmddOiBTcGVjaWZpZWREYXRhVHlwZTxULCBOPiB9XG4gICk6IEludGVybmFsUm93PFQsIE4+IHtcbiAgICAvLyBUT0RPOiBTaGFyZSBjb2x1bW4gbmFtZXNcbiAgICBsZXQgY29sdW1uTmFtZXMgPSBPYmplY3Qua2V5cyhyb3cpO1xuICAgIGxldCBjb2x1bW5zID0gT2JqZWN0LnZhbHVlcyhyb3cpLm1hcCh2ID0+IG5vcm1hbGl6ZURhdGFUeXBlKHYpKTtcblxuICAgIHJldHVybiBuZXcgSW50ZXJuYWxSb3coZW50aXR5LCBjb2x1bW5OYW1lcywgY29sdW1ucykgYXMgSW50ZXJuYWxSb3c8VCwgTj47XG4gIH1cblxuICBAdHJhY2tlZCBjb2x1bW5zOiBBcnJheTxEYXRhVmFsdWU8VD4+O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHJlYWRvbmx5IGVudGl0eTogRW50aXR5PE4+LFxuICAgIHByaXZhdGUgY29sdW1uTmFtZXM6IHN0cmluZ1tdLFxuICAgIGNvbHVtbnM6IEFycmF5PERhdGFWYWx1ZTxUPj5cbiAgKSB7XG4gICAgdGhpcy5jb2x1bW5zID0gY29sdW1ucztcbiAgfVxuXG4gIGdldCBpZCgpOiBQcmltYXJ5S2V5IHtcbiAgICByZXR1cm4gdGhpcy5lbnRpdHkuaWQ7XG4gIH1cblxuICB1cGRhdGUodXBkYXRlczogeyBba2V5OiBzdHJpbmddOiBEYXRhVmFsdWU8VD4gfSk6IHZvaWQge1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jb2x1bW5OYW1lcy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IGNvbHVtbk5hbWUgPSB0aGlzLmNvbHVtbk5hbWVzW2ldO1xuXG4gICAgICBpZiAoY29sdW1uTmFtZSBpbiB1cGRhdGVzKSB7XG4gICAgICAgIHRoaXMuY29sdW1uc1tpXSA9IHVwZGF0ZXNbY29sdW1uTmFtZV07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gaGFjazogaW52YWxpZGF0ZSBjb2x1bW5zXG4gICAgdGhpcy5jb2x1bW5zID0gdGhpcy5jb2x1bW5zO1xuICB9XG5cbiAgc2VsZWN0PEsgZXh0ZW5kcyBrZXlvZiBUW05dICYgc3RyaW5nPihcbiAgICBjb2x1bW5zOiByZWFkb25seSBLW11cbiAgKTogeyBbUCBpbiBLXTogVFtOXVtLXSB9IHtcbiAgICBsZXQgb3V0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuICAgIGZvciAobGV0IGNvbHVtbiBvZiBjb2x1bW5zKSB7XG4gICAgICBvdXRbY29sdW1uXSA9IHRoaXMuZ2V0Q29sdW1uKGNvbHVtbik7XG4gICAgfVxuXG4gICAgcmV0dXJuIG91dDtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0Q29sdW1uPEsgZXh0ZW5kcyBrZXlvZiBUW05dICYgc3RyaW5nPihuYW1lOiBLKTogdW5rbm93biB7XG4gICAgbGV0IGluZGV4ID0gdGhpcy5jb2x1bW5JbmRleChuYW1lKTtcbiAgICByZXR1cm4gdGhpcy5jb2x1bW5zW2luZGV4XTtcbiAgfVxuXG4gIHByaXZhdGUgY29sdW1uSW5kZXg8SyBleHRlbmRzIGtleW9mIFRbTl0gJiBzdHJpbmc+KG5hbWU6IEspOiBudW1iZXIge1xuICAgIGxldCBpbmRleCA9IHRoaXMuY29sdW1uTmFtZXMuaW5kZXhPZihuYW1lKTtcblxuICAgIGFzc2VydChcbiAgICAgIGluZGV4ID4gLTEsXG4gICAgICBgWW91IHRyaWVkIHRvIG1hdGNoIGNvbHVtbiAke25hbWV9IGluIHRhYmxlICR7XG4gICAgICB0aGlzLmVudGl0eS50YWJsZVxuICAgICAgfSBidXQgaXQgZGlkbid0IGV4aXN0IChjb2x1bW5zOiAke3RoaXMuY29sdW1uTmFtZXMuam9pbihcIiwgXCIpfSlgXG4gICAgKTtcblxuICAgIHJldHVybiBpbmRleDtcbiAgfVxuXG4gIGlzTWF0Y2gocXVlcnk6IFF1ZXJ5PFQsIE4+KTogYm9vbGVhbiB7XG4gICAgZm9yIChsZXQga2V5IG9mIE9iamVjdC5rZXlzKHF1ZXJ5KSkge1xuICAgICAgbGV0IGluZGV4ID0gdGhpcy5jb2x1bW5JbmRleChrZXkgYXMgYW55KTtcblxuICAgICAgbGV0IHBhdHRlcm4gPSAocXVlcnkgYXMgYW55KVtrZXldO1xuICAgICAgbGV0IHZhbHVlID0gdGhpcy5jb2x1bW5zW2luZGV4XTtcblxuICAgICAgaWYgKCFpc0RhdGFNYXRjaChwYXR0ZXJuLCB2YWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmV4cG9ydCB0eXBlIFByaW1hcnlLZXkgPSBJZFZhbHVlW107XG5cbmV4cG9ydCBpbnRlcmZhY2UgRW50aXR5PFQgZXh0ZW5kcyBzdHJpbmc+IHtcbiAgdGFibGU6IFQ7XG4gIGlkOiBQcmltYXJ5S2V5O1xufVxuXG5leHBvcnQgdHlwZSBTcGVjaWZpZWRSb3c8VCBleHRlbmRzIFR5cGVzLCBOIGV4dGVuZHMga2V5b2YgVCAmIHN0cmluZz4gPSB7XG4gIGlkOiBQcmltYXJ5S2V5IHwgc3RyaW5nO1xufSAmIHtcbiAgW2tleTogc3RyaW5nXTogU3BlY2lmaWVkRGF0YVR5cGU8VCwgTj47XG59O1xuXG5leHBvcnQgY29uc3QgRU1QVFkgPSBTeW1ib2woXCJFTVBUWVwiKTtcbmV4cG9ydCBjb25zdCBGSUxURVIgPSBTeW1ib2woXCJGSUxURVJcIik7XG5leHBvcnQgY29uc3QgQUREX1JPVyA9IFN5bWJvbChcIkFERF9ST1dcIik7XG5leHBvcnQgY29uc3QgU0NIRU1BID0gU3ltYm9sKFwiU0NIRU1BXCIpO1xuXG5leHBvcnQgaW50ZXJmYWNlIFR5cGU8VCBleHRlbmRzIFR5cGVzPiB7XG4gIFtrZXk6IHN0cmluZ106IERhdGFWYWx1ZTxUPjtcbn1cblxuZXhwb3J0IHR5cGUgU3BlY2lmaWVkUXVlcnk8VCBleHRlbmRzIFR5cGVzLCBLIGV4dGVuZHMga2V5b2YgVD4gPSB7XG4gIFtQIGluIGtleW9mIFRbS11dPzogVFtLXVtQXTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFRhYmxlPFQgZXh0ZW5kcyBUeXBlcywgTiBleHRlbmRzIGtleW9mIFQgJiBzdHJpbmc+IHtcbiAgQHRyYWNrZWQgbWFwID0gbmV3IFByaW1hcnlLZXlNYXA8SW50ZXJuYWxSb3c8VCwgTj4+KCk7XG5cbiAgY29uc3RydWN0b3IocmVhZG9ubHkgbmFtZTogTiwgcHJpdmF0ZSBzY2hlbWE6IFNjaGVtYSkgeyB9XG5cbiAgZ2V0IFtTQ0hFTUFdKCk6IFNjaGVtYSB7XG4gICAgcmV0dXJuIHRoaXMuc2NoZW1hO1xuICB9XG5cbiAgW0VNUFRZXSgpOiBUYWJsZTxULCBOPiB7XG4gICAgcmV0dXJuIG5ldyBUYWJsZSh0aGlzLm5hbWUsIHRoaXMuc2NoZW1hKTtcbiAgfVxuXG4gIFtGSUxURVJdKHF1ZXJ5OiBRdWVyeTxULCBOPik6IFJlYWRvbmx5QXJyYXk8RW50aXR5PE4+PiB7XG4gICAgbGV0IG91dCA9IFtdO1xuXG4gICAgZm9yIChsZXQgcm93IG9mIHRoaXMubWFwLnZhbHVlcygpKSB7XG4gICAgICBpZiAocm93LmlzTWF0Y2gocXVlcnkpKSB7XG4gICAgICAgIG91dC5wdXNoKHJvdy5lbnRpdHkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICBbQUREX1JPV10ocm93OiBJbnRlcm5hbFJvdzxULCBOPik6IEVudGl0eTxOPiB7XG4gICAgdGhpcy5tYXAuc2V0KHJvdy5pZCwgcm93KTtcblxuICAgIC8vIGhhY2s6IG5vdGlmeSB0aGUgbWFwXG4gICAgdGhpcy5tYXAgPSB0aGlzLm1hcDtcblxuICAgIHJldHVybiB7XG4gICAgICB0YWJsZTogdGhpcy5uYW1lLFxuICAgICAgaWQ6IHJvdy5pZFxuICAgIH07XG4gIH1cblxuICBhbGwoKTogUmVhZG9ubHlBcnJheTxFbnRpdHk8Tj4+IHtcbiAgICBsZXQgb3V0ID0gW107XG5cbiAgICBmb3IgKGxldCByb3cgb2YgdGhpcy5tYXAudmFsdWVzKCkpIHtcbiAgICAgIG91dC5wdXNoKHsgdGFibGU6IHRoaXMubmFtZSwgaWQ6IHJvdy5pZCB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgZmlyc3QoKTogRW50aXR5PE4+IHtcbiAgICBmb3IgKGxldCBrZXkgb2YgdGhpcy5tYXAua2V5cygpKSB7XG4gICAgICByZXR1cm4geyB0YWJsZTogdGhpcy5uYW1lLCBpZDoga2V5IH07XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYWxsZWQgZmlyc3QoKSBvbiBhbiBlbXB0eSBkYXRhYmFzZWApO1xuICB9XG5cbiAgZ2V0KGlkOiBQcmltYXJ5S2V5KTogSW50ZXJuYWxSb3c8VCwgTj4ge1xuICAgIGxldCByb3cgPSB0aGlzLm1hcC5nZXQoaWQpO1xuICAgIGFzc2VydChyb3csIGBSb3cgbm90IGZvdW5kICgke2lkfSlgKTtcbiAgICByZXR1cm4gcm93O1xuICB9XG5cbiAgYWRkKHJvdzogU3BlY2lmaWVkUm93PFQsIE4+KTogSW50ZXJuYWxSb3c8VCwgTj4ge1xuICAgIGxldCB1c2VyUm93ID0gSW50ZXJuYWxSb3cuY3JlYXRlKFxuICAgICAgeyB0YWJsZTogdGhpcy5uYW1lLCBpZDogQXJyYXkuaXNBcnJheShyb3cuaWQpID8gcm93LmlkIDogW3Jvdy5pZF0gfSxcbiAgICAgIHJvd1xuICAgICk7XG4gICAgdGhpc1tBRERfUk9XXSh1c2VyUm93KTtcbiAgICByZXR1cm4gdXNlclJvdztcbiAgfVxuXG4gIHJlcGxhY2UoaWQ6IFByaW1hcnlLZXksIG5ld1JvdzogU3BlY2lmaWVkUm93PFQsIE4+KSB7XG4gICAgLy8gVE9ETzogQXNzZXJ0IGFsbCBjb2x1bW5zIHByZXNlbnRcbiAgICBsZXQgcm93ID0gdGhpcy5nZXQoaWQpO1xuICAgIHJvdy51cGRhdGUobmV3Um93KTtcbiAgfVxufVxuIl19